# 0. 表紙

| モジュール名 | プログラムID | プログラム名           |
| ------------ | ------------ | ---------------------- |
| IC           | LDPJ0004     | AIRS手持在庫変動リスト |

| RFC       | Version | 更新日     | 更新者 | 更新内容 | 確認日     | 確認者 | 承認日     | 承認者 |
| --------- | :-----: | ---------- | :----: | -------- | ---------- | :----: | ---------- | :----: |
| XXXX-XXXX |  1.0.0  | 2025/11/19 | 陳培煌 | 初版作成 | 2025/XX/XX |  XXX  | 2025/XX/XX |  XXX  |

## 1. 処理概要

### 1.1. 機能概要

手持在庫変動ログから、リスト未出力レコードを抽出し、PDFでリスト出力する。
抽出レコードを出力済に更新する。
ログ：共通の部品を用いる(lombok)

### 1.2. 処理概要フロー

### 1.3. プログラム入出力パラメータ

#### 1.3.1. 引数

| No. | パラメータ論理名 | パラメータ物理名 | 属性 | 識別 | 備考 |
| --- | ---------------- | ---------------- | ---- | ---- | ---- |
| 1   |                  |                  |      |      |      |

#### 1.3.2. 戻り値

| No. | パラメータ論理名 | パラメータ物理名 | 属性 | 備考 |
| --- | ---------------- | ---------------- | ---- | ---- |
| 1   |                  |                  |      |      |

### 1.4. その他制御・要件

| 排他制御 |      |      |
| -------- | ---- | ---- |
| 楽観     | 悲観 | 無し |
| -        | -    | ●   |

| 項目               | 制約・制御・要件など                                                 | 記載内容説明                                                                                                       |
| ------------------ | -------------------------------------------------------------------- | ------------------------------------------------------------------------------------------------------------------ |
| パフォーマンス要件 | IC分析本体で、リストデータは作成されるが、リスト作成は後処理で行う。 | リストはPDFファイルとする。 更新系の本体処理では、パフォーマンスを維持するため、PDFファイルは、 後処理で実施する。 |

### 1.5. 入出力一覧

| No | 入出力対象 | 名称                   | 物理名称         | C  | R  | U  | D | 備考        |
| -- | ---------- | ---------------------- | ---------------- | -- | -- | -- | - | ----------- |
| 1  | テーブル   | 手持在庫変動ログ       | ld_trn_fluct_log | -  | ○ | ○ | - |             |
| 2  | テーブル   | 品目共通               | la_itemcomn      | -  | ○ | -  | - |             |
| 3  | テーブル   | IC工場処理日           | ld_mst_slip_date | -  | ○ | -  | - |             |
| 4  | 帳票       | AIRS手持在庫変動リスト | LDAR23           | ○ | -  | -  | - | PDFファイル |

## 2. 詳細処理

### 2.1. 引数の受け取りとチェック

### 2.2. 初期処理

- 工場処理日を検索する

  ```sql
        SELECT ic_slip_date    -- IC工場処理日
          FROM ld_mst_slip_date -- IC工場処理日
         WHERE operation_type = 'STD'
  ```

  - 取得した工場処理日が存在しない場合、エラーロゴを出力する、異常終了する。
  - 存在する場合、変数.工場処理日にセットする

#### 2.2.1. 変数初期化

### 2.3. 主処理

#### 2.3.1. AIRS手持在庫変動リストから、リスト未出力レコードを抽出し、未出力リストに格納する

```sql
     SELECT A.org_section_mrp          AS orgSectionMrp        -- 課
           ,A.org_person_mrp           AS orgPersonMrp         -- 担当者コード
           ,A.ic_slip_date             AS icSlipDate           -- 日付
           ,B.global_itemno            AS globalItemno         -- 編集品目番号
           ,A.supplier                 AS supplier             -- 供給者
           ,A.usercd                   AS usercd               -- 使用者
           ,A.maintenance_datetime     AS maintenanceDatetime  -- メンテナンス日時
           ,A.list_flg                 AS listFlg              -- リスト出力フラグ
           ,A.parent_itemno            AS parentItemno         -- 前品目番号
           ,A.parent_supplier          AS parentSupplier       -- 前供給者
           ,A.parent_usercd            AS parentUsercd         -- 前使用者
           ,A.before_oh_qty            AS beforeOhQty          -- 変更前在庫数量
           ,A.fluct_qty                AS fluctQty             -- 変動数量
           ,A.after_oh_qty             AS afterOhQty           -- 変更後在庫数量
           ,COALESCE(B.item_name, ' ') AS itemName             -- 品目名称
       FROM ld_trn_fluct_log A    -- 手持在庫変動ログ
  LEFT JOIN la_itemcomn B         -- 品目共通
         ON A.itemno = B.itemno
      WHERE A.list_flg = '0'
   ORDER BY A.org_section_mrp
           ,A.org_person_mrp
           ,A.itemno
           ,A.supplier
           ,A.usercd
           ,A.parent_itemno
           ,A.parent_supplier
           ,A.parent_usercd
```

#### 2.3.2. 帳票出力

- 帳票出力
  - 担当課毎にリストファイルを分割する　ファイル名「AIRS手持在庫変動リストyyyymmdd_xx」（リスト名＋工場処理日＋担当課）
  - 改ページ条件：担当者、担当課が変更された時また明細行が最大表示行数を超えた時

### 2.4. 終了処理

## 3. ファイル出力（帳票、CSV、テキスト、Excelなど）

### 3.1. 帳票出力

#### 3.1.1. 帳票レイアウト

![LDPJ0004_AIRS手持在庫変動リスト_帳票レイアウト_image_001](image/LDPJ0004/LDPJ0004_001.png)

#### 3.1.2. 帳票項目定義

| No | エリア     | 項目名 | 項目物理名 | 種別 | 表示/非表示 | 最大 | 最小 | 小数桁 | 表示位置 | 表示時編集内容                     | ソース名   | 項目名 | ソート順                                                                                                              | 備考 |
| -- | ---------- | ------ | ---------- | ---- | ----------- | ---- | ---- | ------ | -------- | ---------------------------------- | ---------- | ------ | --------------------------------------------------------------------------------------------------------------------- | ---- |
| 1  | リストID   | ヘッダ | 文字列     | 固定 | 7           |      | 7    |        | 左揃え   | 固定：LDAR023                      |            |        |                                                                                                                       |      |
| 2  | 発行日     | ヘッダ | 日付       | 可変 | 10          |      | 8    |        | 左揃え   | システム日付                       | YYYY-MM-DD |        |                                                                                                                       |      |
| 3  | ページ     | ヘッダ | 数値       | 可変 | 4           |      | 4    |        | 右揃え   | 1から採番                          |            |        |                                                                                                                       |      |
| 4  | 担当課     | ヘッダ | 文字列     | 可変 | 2           |      | 2    |        | 左揃え   | 手持在庫変動ログ．担当課           |            | 1      | 担当課毎にリストファイルを分割するファイル名「ＡＩＲＳ手持在庫変動リストyyyymmdd_課」（リスト名＋工場処理日＋担当課） |      |
| 5  | 担当者     | ヘッダ | 文字列     | 可変 | 3           |      | 3    |        | 左揃え   | 手持在庫変動ログ．担当者           |            | 2      | 担当者毎に改ページする                                                                                                |      |
| 6  | 品目番号   | 明細   | 文字列     | 可変 | 18          |      | 14   |        | 左揃え   | 手持在庫変動ログ．品目番号         |            | 3      |                                                                                                                       |      |
| 7  | 品目名称   | 明細   | 文字列     | 可変 | 30          |      | 30   |        | 左揃え   | 品目共通                           |            |        |                                                                                                                       |      |
| 8  | 供給者     | 明細   | 文字列     | 可変 | 4           |      | 4    |        | 中央     | 手持在庫変動ログ．供給者           |            | 4      |                                                                                                                       |      |
| 9  | 使用者     | 明細   | 文字列     | 可変 | 4           |      | 4    |        | 中央     | 手持在庫変動ログ．使用者           |            | 5      |                                                                                                                       |      |
| 10 | 親品目番号 | 明細   | 文字列     | 可変 | 18          |      | 14   |        | 左揃え   | 手持在庫変動ログ．親品目番号       |            | 6      |                                                                                                                       |      |
| 11 | 親供給者   | 明細   | 文字列     | 可変 | 4           |      | 4    |        | 中央     | 手持在庫変動ログ．親供給者         |            | 7      |                                                                                                                       |      |
| 12 | 親使用者   | 明細   | 文字列     | 可変 | 4           |      | 4    |        | 中央     | 手持在庫変動ログ．親使用者         |            | 8      |                                                                                                                       |      |
| 13 | 変動前数   | 明細   | 数値       | 可変 | 10          | 0    | 7    |        | 右揃え   | 手持在庫変動ログ．更新前手持在庫数 |            |        |                                                                                                                       |      |
| 14 | 変動数     | 明細   | 数値       | 可変 | 10          | 0    | 7    |        | 右揃え   | 手持在庫変動ログ．変動数           |            |        |                                                                                                                       |      |
| 15 | 変動後数   | 明細   | 数値       | 可変 | 10          | 0    | 7    |        | 右揃え   | 手持在庫変動ログ．更新後手持在庫数 |            |        |                                                                                                                       |      |

### 3.2. ファイル入出力（CSV、テキスト、Excel など）

#### 3.2.1. ファイルレイアウト

## 4. 補足

### 4.1. 補足説明任意記入
