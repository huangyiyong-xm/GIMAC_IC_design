# 0. 表紙

| モジュール名 | プログラムID | プログラム名             |
| ------------ | ------------ | ------------------------ |
| IC           | LDAS9011     | 在庫情報抽出(組織コード) |

| RFC | Version | 更新日     | 更新者 | 更新内容 | 確認日     | 確認者 | 承認日     | 承認者 |
| --- | :-----: | ---------- | :----: | -------- | ---------- | :----: | ---------- | :----: |
| -   |  1.0.0  | 2025/09/30 | 余暁東 | 初版作成 | 2025/XX/XX |  XXX  | 2025/XX/XX |  XXX  |

## 1. 処理概要

### 1.1. 機能概要

引数の組織コードから組織下位展開を行い、SUコードを取得
そのSUコードから使用者の現時点の在庫数を抽出する
引数によって出力対象を制御する
・画面(S/U別在庫照会：LDB05)と同等の機能で、使用者をエリアコード(GIMACエリアマスタ)から取得し、複数SU分を一括抽出する。
・社外SUを抽出したい場合、引数として社外SUを任意指定して渡されてくるため、そのSUごとの在庫数を抽出する

### 1.2. 処理概要フロー

### 1.3. プログラム入出力パラメータ

#### 1.3.1. 引数

| No. | パラメータ論理名 | パラメータ物理名     | 属性    | 備考                                                                       |
| --- | ---------------- | -------------------- | ------- | -------------------------------------------------------------------------- |
| 1   | 組織コード7桁-1  | ps_org_typw_cd_1     | VARCHAR | 組織タイプ(3桁)＋組織コード(4)（必須)                                      |
| 2   | 組織コード7桁-2  | ps_org_typw_cd_2     | VARCHAR | 組織タイプ(3桁)＋組織コード(4)（空白有り)                                  |
| 3   | S/Uサイン        | ps_su_sign           | VARCHAR | ALL:1S=U:2S≠U:3(必須)                                                     |
| 4   | 供給者           | ps_supplier          | VARCHAR | （任意）                                                                   |
| 5   | 納入P/F          | ps_deliv_pf_no       | VARCHAR | （任意）                                                                   |
| 6   | 投入作業区       | ps_input_work_center | VARCHAR | （任意）                                                                   |
| 7   | A/Nサイン        | ps_act_sign          | VARCHAR | ALL:1ACTIVE:2NOTACTIVE:3(必須)                                             |
| 8   | 在庫数サイン     | ps_oh_sign           | VARCHAR | ALL:1マイナス在庫:2(必須)                                                  |
| 9   | 組織展開基準日   | ps_explosion_date    | VARCHAR | 最新:空白日付指定:yyyymmdd                                                 |
| 10  | 外注SU           | ps_out_su            | VARCHAR | 社外外注SUを構成から取得できない関係でユーザーが入力した複数の外注SUが入る |

#### 1.3.2. 戻り値

| No. | パラメータ論理名 | パラメータ物理名     | 属性    | 備考                                  |
| --- | ---------------- | -------------------- | ------- | ------------------------------------- |
| 1   | SPステータス     | rs_sp_status         | INTEGER | 0：NormalEnd－1：SQLError－2：PGError |
| 2   | SQLコード        | rs_sql_error         | VARCHAR |                                       |
| 3   | ISAMコード       | rs_isam_error        | VARCHAR |                                       |
| 4   | PGステータス     | rs_pg_status         | VARCHAR |                                       |
| 5   | エラー位置       | rs_errs_focus        | VARCHAR |                                       |
| 6   | 品目番号         | rs_itemno            | VARCHAR |                                       |
| 7   | 供給者           | rs_supplier          | VARCHAR |                                       |
| 8   | 使用者           | rs_usercd            | VARCHAR |                                       |
| 9   | 品目名称         | rs_Item_name         | VARCHAR |                                       |
| 10  | 供給者名称       | rs_s_name            | VARCHAR |                                       |
| 11  | 供給者担当課     | rs_s_section         | VARCHAR |                                       |
| 12  | 供給者担当者     | rs_s_person_cd       | VARCHAR |                                       |
| 13  | 使用者名称       | rs_u_name            | VARCHAR |                                       |
| 14  | 使用者担当課     | rs_u_section         | VARCHAR |                                       |
| 15  | 使用者担当者     | rs_u_person_cd       | VARCHAR |                                       |
| 16  | 品目ステータス   | rs_item_status       | VARCHAR |                                       |
| 17  | P/F              | rs_deliv_pf_no       | VARCHAR |                                       |
| 18  | 格納ロケーション | rs_stock_location    | VARCHAR |                                       |
| 19  | 作業区           | rs_input_work_center | VARCHAR |                                       |
| 20  | 手持ち在庫       | rs_oh_qty            | DECIMAL |                                       |
| 21  | 更新日時         | rs_current_datetime  | VARCHAR |                                       |
| 22  | 組織展開基準日   | rs_explosion_date    | VARCHAR |                                       |

### 1.4. その他制御・要件

| 排他制御 |      |      |
| -------- | ---- | ---- |
| 楽観     | 悲観 | 無し |
| ●       | -    | -    |

| 項目               | 制約・制御・要件など                                                                | 記載内容説明                                                     |
| ------------------ | ----------------------------------------------------------------------------------- | ---------------------------------------------------------------- |
| パフォーマンス要件 | 特になし。 ユーザーが入力した外注SU（複数ある場合、複数）情報を取得する処理が欲しい | 特別なパフォーマンス要件がある場合に要件内容とその対処法を記述。 |

### 1.5. 入出力一覧

| No | 入出力対象 | 名称              | 物理名称               | C | R  | U | D | 備考                |
| -- | ---------- | ----------------- | ---------------------- | - | -- | - | - | ------------------- |
| 1  | テーブル   | 在庫ファイル      | ld_inv_trn             | - | ○ | - | - | 旧：ic_inv_trn      |
| 2  | テーブル   | 品目マスタ        | la_itemmast            | - | ○ | - | - | 旧：de_itemmast     |
| 3  | テーブル   | MRP情報値         | le_mst_mrp_information | - | ○ | - | - | 旧：de_itemmast_mrp |
| 4  | テーブル   | 品目共通          | la_itemcomn            | - | ○ | - | - | 旧：de_itemcomn     |
| 5  | テーブル   | GIMACエリアマスタ | la_area_master         | - | ○ | - | - | 旧：com_orgmast     |
| 6  | テーブル   | SUマスタ          | la_area_master_su      | - | ○ | - | - | 旧：com_orgmast_su  |

## 2. 詳細処理

### 2.1. 引数の受け取りとチェック

#### 2.1.1. 組織コードチェック

- 組織コード7桁-1（ps_org_typw_cd_1）がNULLまたは長さが7桁でない場合、空白に設定。
- 組織コード7桁-2（ps_org_typw_cd_2）がNULLまたは長さが7桁でない場合、空白に設定。
- 両方の組織コードが空白の場合、エラーメッセージを出力し処理終了。
  - エラーコード：'E.XXXXXXXX'
  - エラーメッセージ：''

#### 2.1.2. 引数バリデーション

- S/Uサイン（ps_su_sign）が'1'（ALL）、'2'（S=U）、'3'（S≠U）以外の場合、エラーメッセージを出力し処理終了。

  - エラーコード：'E.XXXXXXXX'
  - エラーメッセージ：''
- 供給者（ps_supplier）がNULLの場合は空白に設定。
- 納入P/F（ps_deliv_pf_no）がNULLの場合は空白に設定。
- 投入作業区（ps_input_work_center）がNULLの場合は空白に設定。
- A/Nサイン（ps_act_sign）が'1'（ALL）、'2'（ACTIVE）、'3'（NOTACTIVE）以外の場合、エラーメッセージを出力し処理終了。

  - エラーコード：'E.XXXXXXXX'
  - エラーメッセージ：''
- 在庫数サイン（ps_oh_sign）が'1'（ALL）、'2'（マイナス在庫のみ）以外の場合、エラーメッセージを出力し処理終了。

  - エラーコード：'E.XXXXXXXX'
  - エラーメッセージ：''

#### 2.1.3. 組織展開基準日チェック

- 組織展開基準日（ps_explosion_date）が空白またはNULLの場合は"99999998"に設定。
- 8桁でない場合、エラーメッセージを出力し処理終了。

  - エラーコード：'E.XXXXXXXX'
  - エラーメッセージ：''
- 各文字が数字（0-9）でない場合、エラーメッセージを出力し処理終了。

  - エラーコード：'E.XXXXXXXX'
  - エラーメッセージ：''

#### 2.1.4. 組織コード有効性チェック

組織コード1、2それぞれについて以下をチェック：

- GIMACエリアマスタに該当レコードが存在するかチェック。

```sql
SELECT エリアカテゴリ 
  FROM GIMACエリアマスタ
 WHERE エリアコード =  COALESCE(
    NULLIF(TRIM(引数.組織コード7桁_1), ''),
    NULLIF(TRIM(引数.組織コード7桁_2), '')
  );
```

- データが存在する場合、エリアカテゴリが"02","03","04","05","06","53","56"のいずれかをチェック。
- 条件を満たさない場合は該当組織コードを空白に設定。
- 両方の組織コードが無効の場合、エラーメッセージを出力し処理終了。
  - エラーコード：'E.XXXXXXXX'
  - エラーメッセージ：''

### 2.2. 初期処理

#### 2.2.1. 変数初期化

### 2.3. 主処理

#### 2.3.1. 一時テーブル作成

SUコード格納用の一時テーブルを作成：

```sql
CREATE TEMP TABLE tmp_ldas9011_su(
    su_code VARCHAR(4)
);
```

#### 2.3.2. 組織展開処理

##### 2.3.2.1. 組織下位展開

有効な組織コード（1または2）それぞれについて以下を実行：

1. LAFS0107（組織構成構造検索コントロール）をコールする

   ```sql
   SELECT * 
     FROM LAFS0107("D",                                -- 展開方向
                   substr('引数.組織コード7桁-1', 1, 3),   -- エリア構成タイプ
                   substr('引数.組織コード7桁-1', 4, 7),   -- エリアコード
                   引数.展開基準日,                      -- 展開基準日
                   " ",                                 --展開レベル 
                   "Y"                                  --使用禁止除外区分
                   )
   ```

2. 戻り値のエリアカテゴリが"06"または"56"の場合：

   - エリアコードの末尾4桁をSUコードとして取得
   - 一時テーブル（tmp_ldas9011_su）に取得した.SUコードを挿入

```sql
insert into tmp_ldas9011_su
  (
  su_code
  )
values(
  取得した.SUコード
  );
```

 - 一時テーブル（tmp_ldas9011_su）に引数.SUコードを挿入

```sql
insert into tmp_ldas9011_su
  (
  su_code
  )
values(
  NULLIF(TRIM(引数.外注SU), '')
  );
```

1. SP（LAFS0107）からエラーが返された場合は処理を中止しエラーを返す

#### 2.3.3. 品目情報抽出

一時テーブル(tmp_ldas9011_su)から取得したSUコードを使って品目情報を抽出する。

```sql
SELECT DISTINCT
       A.品目番号,
       A.供給者,
       A.使用者,
       D.品目名称,
       F.エリア名称,    -- 供給者名称
       F.担当課,       -- 供給者担当課
       F.担当者,       -- 供給者担当者
       I.エリア名称,   -- 使用者名称
       I.担当課,       -- 使用者担当課
       I.担当者,       -- 使用者担当者
       A.品目ステータス,
       B.納入PF番号,
       B.格納ロケーション,
       B.投入作業区,
       C.手持在庫数,
       C.更新日時,
       CASE WHEN B.AIRSサイン = ' ' 
            THEN E.AIRSサイン
            ELSE B.AIRSサイン
            END AS "AIRSサイン"
 FROM tmp_ldas9011_su T
JOIN 品目マスタ A
  ON T.SUコード = A.使用者
JOIN MRP情報値 B
  ON A.品目番号 = B.品目番号
 AND A.供給者 = B.供給者
 AND A.使用者 = B.使用者
JOIN 在庫ファイル C
  ON A.品目番号 = C.品目番号
 AND A.供給者 = C.供給者
 AND A.使用者 = C.使用者
JOIN 品目共通 D
  ON A.品目番号 = D.品目番号
-- 供給者の SU/エリア
LEFT JOIN SUマスタ E
  ON E.SUコード = A.供給者
LEFT JOIN GIMACエリアマスタ F
  ON E.エリアコード = F.エリアコード
-- 使用者の SU/エリア（使用別別名）
LEFT JOIN SUマスタ H
  ON H.SUコード = A.使用者
LEFT JOIN GIMACエリアマスタ I
  ON H.エリアコード = I.エリアコード
WHERE A.品目クラス IN ('2','7')
  AND ( 引数.供給者 = ' ' OR A.供給者 = 引数.供給者 )
ORDER BY A.品目番号, A.供給者, A.使用者;
```

#### 2.3.4. 取得データの順次処理

2.3.3で取得したレコードを1件ずつ処理し、以下の条件チェックを全レコードが処理完了するまで繰り返す。

##### 2.3.4.1. AIRSサイン判定

取得したレコードのAIRSサインをチェックし、'1'の場合は次のレコードの処理へ移行する。

##### 2.3.4.2. SUサイン判定

引数のSUサインに基づいてフィルタリングを行う。

- 引数.S/Uサイン = '2' かつ 取得した.供給者 ≠ 取得した.使用者 の場合：次のレコードの処理へ移行する
- 引数.S/Uサイン = '3' かつ 取得した.供給者 = 取得した.使用者 の場合：次のレコードの処理へ移行する

##### 2.3.4.3. 納入PF番号判定

引数の納入PF番号に基づいてフィルタリングを行う。

- 引数.納入PF番号 ≠ ' ' かつ 引数.納入PF番号 ≠ 取得した.納入PF番号 の場合：次のレコードの処理へ移行する

##### 2.3.4.4. 投入作業区判定

引数の投入作業区に基づいてフィルタリングを行う。

- 引数.投入作業区 ≠ ' ' かつ 引数.投入作業区 ≠ 取得した.投入作業区 の場合：次のレコードの処理へ移行する

##### 2.3.4.5. A/Nサイン判定

引数のA/Nサインに基づいてフィルタリングを行う。

- 引数.A/Nサイン = '2' かつ 取得した.オーダーサイン ≠ '1' の場合：次のレコードの処理へ移行する
- 引数.A/Nサイン = '3' かつ 取得した.オーダーサイン IS NOT NULL かつ 取得した.オーダーサイン = '1' の場合：次のレコードの処理へ移行する

##### 2.3.4.6. 在庫数サイン判定

引数の在庫数サインに基づいてフィルタリングを行う。

- 引数.在庫数サイン = '2' かつ 取得した.手持在庫数 >= 0 の場合：次のレコードの処理へ移行する

##### 2.3.4.7. 結果データ返却

検索条件を満たすレコードを戻り値に設定し、WITH RESUME付きで返却する。

該当データが存在することを示すフラグを '1' に設定する。

#### 2.3.5. 処理結果の確認

全レコードの処理が完了後、該当データ存在フラグをチェックする。

該当データ存在フラグが '0' の場合（該当データが存在しない場合）、データ無しエラー（例外コード = 100）を発生させる。

#### 2.3.6. 後片付け（DROP TEMP TABLE）

一時テーブル作成フラグ l_tmp_tbl_cre = '1' の場合は、処理終了前に `tmp_ldas9011_su` を DROP する。

例外処理:

- SQLエラー発生時: 一時テーブルが存在すれば削除して、r_sp_status=-1, r_sql_error/r_isam_error を返す。
- PGエラー発生時: エラーコードが 100（データ無し）の場合は 100 を返却、それ以外は -1 を返却する（いずれも一時テーブルは削除）。

### 2.4. 終了処理

- 処理を正常終了する

| 戻り値           | 属性    | 設定値   |
| ---------------- | ------- | -------- |
| 処理ステータス   | INTEGER | 0        |
| SQL コード       | VARCHAR | スペース |
| エラーコード     | VARCHAR | スペース |
| エラーメッセージ | VARCHAR | スペース |

## 3. 補足説明

### 3.1. 戻り値について

- ステータスについて
  0 : Normal
  100 : Not Found
  -1 : Sql Error
  -2 : Program Error

### 3.2. エラー発生時の対応について

### 3.2.1. 業務例外処理

- 業務例外が発生した場合、エラー情報を戻り値にセットする

| 戻り値         | 設定値   |
| -------------- | -------- |
| 処理ステータス | -2       |
| SQL コード     | スペース |

### 3.2.2. その他例外処理

- システム例外が発生した場合、エラー情報を戻り値にセットする

| 戻り値           | 設定値   |
| ---------------- | -------- |
| 処理ステータス   | -1       |
| SQL コード       | SQLSTATE |
| エラーコード     | スペース |
| エラーメッセージ | SQLERRM  |
