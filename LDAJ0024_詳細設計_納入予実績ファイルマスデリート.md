# 0. 表紙

| モジュール名 | プログラムID | プログラム名                   |
| ------------ | ------------ | ------------------------------ |
| IC           | LDAJ0024     | 納入予実績ファイルマスデリート |

| RFC | Version | 更新日     | 更新者 | 更新内容 | 確認日     | 確認者 | 承認日     | 承認者 |
| --- | :-----: | ---------- | :----: | -------- | ---------- | :----: | ---------- | :----: |
| -   |  1.0.0  | 2025/09/11 | 陳培煌 | 初版作成 | 2025/XX/XX |  石川  | 2025/XX/XX |   XX   |

## 1. 処理概要

### 1.1. 機能概要

①LDYS0007をコールし工場処理日を取得する
②納入予実績のオーダー状況を更新する
(オーダーステータスが"9"でないかつ納入指示日から1ヶ月以上経過かつオーダー明細・独立所要量明細に存在しないもののオーダーステータスを"9"とする)
③納入予実績の1ヶ月経過データを削除する
(オーダーステータスが"9"でないものは1年以上経過したら削除)
ログ：共通の部品を用いる(lombok)

### 1.2. 処理概要フロー

```mermaid
flowchart LR
    %% メインフローブランチ
    start(["開始"]) --> argBlock --> initBlock --> mainBlock --> endBlock --> endStatus(["終了"])

    %% 引数処理詳細フロー
    subgraph argBlock ["2.1.引数処理"]
      arg_check["2.1.引数の受け取りとチェック"]
    end

    %% 初期処理詳細フロー
    subgraph initBlock ["2.2.初期処理"]
      var_init["2.2.1.変数初期化"]
    end

    %% 主処理詳細フロー
    subgraph mainBlock ["2.3.主処理"]
      get_factory_date["<div style='white-space: nowrap;'>2.3.1.現在工場処理日取得</div>"]
      --> update_record_data["<div style='white-space: nowrap;'>2.3.2.納入予実績のオーダー状況を更新する</div>"]
      --> delee_order_data["<div style='white-space: nowrap;'>2.3.3.納入予実績の1ヶ月経過データを削除する</div>"]
    end

    %% 終了処理
    subgraph endBlock ["2.4.終了処理"]
      end_process["2.4.終了処理"]
    end

    class start,end_process startEnd
    class arg_process,init_process,main_process process
```

### 1.3. プログラム入出力パラメータ

#### 1.3.1. 引数

| No. | パラメータ論理名 | パラメータ物理名 | 属性 | 識別 | 備考 |
| --- | ---------------- | ---------------- | ---- | ---- | ---- |
| 1   |                  |                  |      |      |      |

#### 1.3.2. 戻り値

| No. | パラメータ論理名 | パラメータ物理名 | 属性   | 備考            |
| --- | ---------------- | ---------------- | ------ | --------------- |
| 1   | リターンコード   | r_status         | String | 正常：0異常：-1 |

### 1.4. その他制御・要件

| 排他制御 |      |      |
| -------- | ---- | ---- |
| 楽観     | 悲観 | 無し |
| ●       | -    | -    |

| 項目               | 制約・制御・要件など | 記載内容説明                                                     |
| ------------------ | -------------------- | ---------------------------------------------------------------- |
| パフォーマンス要件 | 特になし。           | 特別なパフォーマンス要件がある場合に要件内容とその対処法を記述。 |

### 1.5. 入出力一覧

| No | 入出力対象 | 名称               | 物理名称                  | C | R  | U  | D  | 備考                    |
| -- | ---------- | ------------------ | ------------------------- | - | -- | -- | -- | ----------------------- |
| 1  | テーブル   | オーダー明細       | le_trn_order              |   | ○ |    |    | 旧テーブルic_order_trn  |
| 2  | テーブル   | 独立所要量明細     | le_trn_ird                |   | ○ |    |    | 旧テーブルic_indreq_trn |
| 3  | テーブル   | リテラル防止要素   | lz_anti_literal_element   |   | ○ |    |    | 現行：ic_fix_val        |
| 4  | テーブル   | 納入予実績         | ld_trn_dlv_pre_record_day |   | ○ | ○ | ○ | 旧テーブルic_od_pr_day  |
| 5  | 共通関数   | 現在工場処理日取得 | LDYS0007                  |   |    |    |    |                         |

## 2. 詳細処理

### 2.1. 引数の取得とチェック

### 2.2. 初期処理

#### 2.2.1. 変数初期化

### 2.3. 主処理

#### 2.3.1. 現在工場処理日取得

- 共通関数LDYS0007をコールし、IC工場処理日を取得する。
- 取得できない場合、エラーログを出力し、異常終了する。
- 取得したIC工場処理日を変数.IC工場処理日にセットする。
- 変数.先月の最初日は変数.IC工場処理日の先月の最初月日にセットする
- 変数.一年前の最初月日は変数.IC工場処理日の一年前の最初月日にセットする

#### 2.3.2. 納入予実績のオーダー状況を更新する

- オーダーステータスが"9"でないかつ納入指示日から1ヶ月以上経過かつオーダー明細・独立所要量明細に存在しないもののオーダーステータスを"9"とする。

```sql
    UPDATE 納入予実績 A
       SET A.オーダーステータス = '9'
          ,更新カウンタ           = 更新カウンタ + 1
          ,更新日時               = システム日時
          ,更新者                 = ログインのユーザーID
          ,更新PGID               = プログラムID
     WHERE A.オーダーステータス    <> '9'
       AND A.納入指示日            < 変数.先月の最初日
       AND (A.オーダー種別 = '1' AND NOT EXISTS (
           SELECT 1
             FROM オーダー明細 B
            WHERE A.品目番号　　　　　　　= B.品目番号
              AND A.供給者　　　　　　　　= B.供給者
              AND A.使用者　　　　　　　　= B.使用者
              AND A.オーダー番号　　　　　= B.オーダー番号
       ))
       AND (A.オーダー種別 = '2' AND NOT EXISTS (
           SELECT 1
             FROM 独立所要量明細 C
            WHERE A.品目番号　　　　　　　= C.品目番号
              AND A.供給者　　　　　　　　= C.供給者
              AND A.使用者　　　　　　　　= C.使用者
              AND A.オーダー番号　　　　　= C.オーダー番号
       ))
       AND NOT EXISTS (
         　SELECT 1
         　  FROM リテラル防止要素 d
         　 WHERE d.システムコード　　　　　='LD'
         　　 AND d.リテラル識別コード　　　='LDA00012'
        　 　 AND d.制御キー１　　　　　　　= A.供給者
         　　 AND d.制御キー２　　　　　　　=''
         　　 AND d.制御キー３　　　　　　　=''
         　　 AND d.制御キー４　　　　　　　=''
         　　 AND d.制御キー５　　　　　　　='');
```

- 更新件数を取得する。

#### 2.3.3. 納入予実績の1ヶ月経過データを削除する(オーダーステータスが"9"でないものは1年以上経過したら削除)

- オーダーステータスが"9"のものは1か月以上経過した場合に、
  オーダーステータスが"9"でないものは1年以上経過した場合に削除します。

```sql
DELETE FROM 納入予実績
      WHERE (オーダーステータス <> '9' AND 納入指示日 < 変数.一年前の最初月日)
        AND (オーダーステータス = '9' AND 納入指示日 < 変数.先月の最初日)
```

- 削除件数を取得する。

### 2.4. 終了処理

- 更新件数をログに出力する。
- 削除件数をログに出力する。
- 正常終了コードを設定し、終了する。

## 3. 補足

### 3.1. 補足説明任意記入
