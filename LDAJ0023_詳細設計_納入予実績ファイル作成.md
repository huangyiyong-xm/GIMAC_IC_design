# 0. 表紙

| モジュール名 | プログラムID | プログラム名           |
| ------------ | ------------ | ---------------------- |
| IC           | LDAJ0023     | 納入予実績ファイル作成 |

| RFC | Version | 更新日     | 更新者 | 更新内容 | 確認日     | 確認者 | 承認日     | 承認者 |
| --- | :-----: | ---------- | :----: | -------- | ---------- | :----: | ---------- | :----: |
| -   |  1.0.0  | 2025/09/11 | 陳培煌 | 初版作成 | 2025/XX/XX |   XX   | 2025/XX/XX |   XX   |

## 1. 処理概要

### 1.1. 機能概要

①LDYS0007をコールしIC工場処理日を取得する
②オーダー明細、独立所要量明細より納入予実績へ追加する（処理区分が"1"の場合当日ハンド追加分、処理区分が"2"の場合今回MRP確定分）
重複データを削除してから追加
削除日が当日の場合は、削除日、削除理由をクリアしてオーダーステータスを"2"に変更する
③（処理区分が"2"の場合のみ当処理を実施）オーダー明細より納入予実績の納入指示日を更新する(MRP需要方針コードが"3"のデータのみ)
④（処理区分が"1"の場合のみ当処理を実施）在庫取引明細_当日分より納入予実績の実績を更新する
⑤（処理区分が"1"の場合のみ当処理を実施）削除オーダーのデータを更新する
ログ：共通の部品を用いる(lombok)

### 1.2. 処理概要フロー

```mermaid
flowchart LR
    %% メインフローブランチ
    start(["開始"]) --> argBlock --> initBlock --> mainBlock --> endBlock --> endStatus(["終了"])

    %% 引数処理詳細フロー
    subgraph argBlock ["2.1.引数処理"]
      arg_check["2.1.引数の受け取りとチェック"]
    end

    %% 初期処理詳細フロー
    subgraph initBlock ["2.2.初期処理"]
      var_init["2.2.1.変数初期化"]
    end

    %% 主処理詳細フロー
    subgraph mainBlock ["2.3.主処理"]
      get_factory_date["<div style='white-space: nowrap;'>2.3.1.現在工場処理日取得</div>"]
      --> create_record_data["<div style='white-space: nowrap;'>2.3.2.オーダー明細、独立所要量明細より納入予実績へ追加する</div>"]
      create_record_data --> | 処理区分 = '2' |update_record_delivery_date["<div style='white-space: nowrap;'>2.3.3.1.オーダー明細より納入予実績の納入指示日を更新する</div>"]
      create_record_data --> | 処理区分 = '1' |update_record_data["<div style='white-space: nowrap;'>2.3.3.2在庫取引明細_当日分より納入予実績の実績を更新する　</div>"]
      --> delete_order_data["<div style='white-space: nowrap;'>2.3.3.4削除オーダーのデータを更新する　</div>"]
    end

    %% 終了処理
    subgraph endBlock ["2.4.終了処理"]
      end_process["2.4.終了処理"]
    end

    class start,end_process startEnd
    class arg_process,init_process,main_process process
```

### 1.3. プログラム入出力パラメータ

#### 1.3.1. 引数

| No. | パラメータ論理名 | パラメータ物理名 | 属性   | 識別 | 備考                                |
| --- | ---------------- | ---------------- | ------ | ---- | ----------------------------------- |
| 1   | 処理区分         | process_class    | String | arg1 | 1:LDBB0001(日次)、2:LDBB0002(MRP後) |

#### 1.3.2. 戻り値

| No. | パラメータ論理名 | パラメータ物理名 | 属性   | 備考            |
| --- | ---------------- | ---------------- | ------ | --------------- |
| 1   | リターンコード   | r_status         | String | 正常：0異常：-1 |

### 1.4. その他制御・要件

| 排他制御 |      |      |
| -------- | ---- | ---- |
| 楽観     | 悲観 | 無し |
| ●       | -    | -    |

| 項目               | 制約・制御・要件など | 記載内容説明                                                     |
| ------------------ | -------------------- | ---------------------------------------------------------------- |
| パフォーマンス要件 | 特になし。           | 特別なパフォーマンス要件がある場合に要件内容とその対処法を記述。 |

### 1.5. 入出力一覧

| No | 入出力対象 | 名称                 | 物理名称                  | C  | R  | U  | D | 備考                      |
| -- | ---------- | -------------------- | ------------------------- | -- | -- | -- | - | ------------------------- |
| 1  | テーブル   | オーダー明細         | le_trn_order              | -  | ○ | -  | - | 旧テーブルic_order_trn    |
| 2  | テーブル   | 独立所要量明細       | le_trn_ird                | -  | ○ | -  | - | 旧テーブルic_order_trn    |
| 3  | テーブル   | 在庫取引明細当日分   | ld_trn_trans_day          | -  | ○ | -  | - | 旧テーブルic_trans_day    |
| 4  | テーブル   | MRP情報値            | le_mst_mrp_information    | -  | ○ | -  | - | 旧テーブルde_itemmast_mrp |
| 5  | テーブル   | 納入予実績           | ld_trn_dlv_pre_record_day | ○ | ○ | ○ | - | 旧テーブルic_od_pr_day    |
| 6  | テーブル   | ICシステムパラメータ | ld_mst_system_parameter   | -  | ○ | -  | - | 旧テーブルic_ctrl         |
| 7  | テーブル   | 確定期間             | le_mst_fix_period         | -  | ○ | -  | - | 旧テーブルmrp_fix_period  |
| 8  | テーブル   | 品目マスタ           | la_itemmast               | -  | ○ | -  | - | 旧テーブルde_itemmast     |
| 9  | テーブル   | SU情報               | la_area_master_su         | -  | ○ | -  | - | 旧テーブルcon_orgmast_su  |
| 10 | テーブル   | リテラル防止要素     | lz_anti_literal_element   | -  | ○ | -  | - | 現行：ic_fix_val          |
| 11 | 共通関数   | 現在工場処理日取得   | LDYS0007                  |    |    |    |   |                           |

## 2. 詳細処理

### 2.1. 引数の受け取りとチェック

- 引数.処理区分が'1':LDBB0001(日次)、'2':LDBB0002(MRP後)以外の場合、エラーログを出力し、異常終了する。

### 2.2. 初期処理

#### 2.2.1. 変数初期化

利用する変数を初期化する。

- 処理区分="1"の場合
  変数.オーダー発行区分 = '2'
- 処理区分="2"の場合
  変数.オーダー発行区分 = '1'

### 2.3. 主処理

#### 2.3.1. 現在工場処理日取得

- 共通関数LDYS0007をコールし、IC工場処理日を取得する。
- 取得できない場合、エラーログを出力し、異常終了する。
- 取得したIC工場処理日を変数.IC工場処理日にセットする。

#### 2.3.2. オーダー明細、独立所要量明細より納入予実績へ追加する

##### 2.3.2.1 オーダー明細より納入予実績へ追加する

- 以下の条件でデータをオーダー明細リストに格納する。

```sql
     SELECT a.品目番号
           ,a.供給者
           ,a.使用者
           ,a.オーダー番号
           ,a.完了日 AS オリジナル納入指示日
           ,b.品目ステータス
           ,c.工程番号
           ,a.MRP需要方針コード
           ,a.シフト分割数
           ,a.シフトパターン番号
           ,c.荷姿コード
           ,c.荷姿収容数
           ,CASE WHEN c.納入PF番号 <> '' THEN '1' ELSE '' END AS 納入PF／送り先区分
           ,a.納入PF番号 AS 納入PF／送り先コード
           ,a.生試初品区分
           ,a.完了日     AS 納入指示日
           ,a.完了開始時間
           ,a.完了終了時間
           ,a.オーダー数 AS 納入指示数
           ,a.供給者     AS 納入キー
           ,a.使用者     AS 受入キー
           ,a.登録者     AS 計画登録者
           ,a.理由コード
       FROM オーダー明細 a
 INNER JOIN 品目マスタ b
         ON a.品目番号　　　　　　　= b.品目番号
        AND a.供給者　　　　　　　　= b.供給者
        AND a.使用者　　　　　　　　= b.使用者
        AND b.品目タイプ　　　　　　= '1'　-- 1:標準
        AND b.品目クラス　　　　　　<> '1'　-- 1:原材料
 INNER JOIN MRP情報値 c
         ON a.品目番号　　　　　　　= c.品目番号
        AND a.供給者　　　　　　　　= c.供給者
        AND a.使用者　　　　　　　　= c.使用者
        AND c.MRP需要方針コード　　 <> '1'　-- 1:生産計画品目
        AND ((c.Wピン管理コード　　 = '0' AND a.シフト分割数 > 0)
              OR (c.Wピン管理コード = '0' AND a.生試初品区分 = '2') -- 2:生試
              OR  C.シンクロ管理    = '1')　-- 0：Wピン管理対象外
      WHERE a.供給者　　　　　　　　<>　a.使用者
        AND a.オーダーステータス　　=　'2'　-- 2：確定
```

- オーダー明細リストの該当データがなくなるまで、1件ずつ以下の処理を実施する。

  - 重複データを削除する

  ```sql
  DELETE FROM 納入予実績
        WHERE 品目番号             = オーダー明細リスト.品目番号
          AND 供給者               = オーダー明細リスト.供給者
          AND 使用者               = オーダー明細リスト.使用者
          AND オーダー番号         = オーダー明細リスト.オーダー番号
          AND オリジナル納入指示日  = オーダー明細リスト.オリジナル納入指示日
  ```

  - 納入予実績へ追加していきます。

  ```sql
  INSERT INTO 納入予実績
      VALUES (オーダー明細リスト.品目番号             -- 品目番号
             ,オーダー明細リスト.供給者               -- 供給者
             ,オーダー明細リスト.使用者               -- 使用者
             ,オーダー明細リスト.オーダー番号         -- オーダー番号
             ,オーダー明細リスト.オリジナル納入指示日 -- オリジナル納入指示日
             ,'1'                                  -- オーダー種別
             ,オーダー明細リスト.品目ステータス       -- 品目ステータス
             ,オーダー明細リスト.工程番号             -- 工程番号
             ,オーダー明細リスト.MRP需要方針コード    -- MRP需要方針コード
             ,オーダー明細リスト.シフト分割数         -- シフト分割数
             ,オーダー明細リスト.シフトパターン番号    -- シフトパターン番号
             ,オーダー明細リスト.荷姿コード           -- 荷姿コード
             ,オーダー明細リスト.荷姿収容数           -- 荷姿収容数
             ,オーダー明細リスト.納入PF／送り先区分   -- 納入PF／送り先区分
             ,オーダー明細リスト.納入PF／送り先コード -- 納入PF／送り先コード
             ,オーダー明細リスト.生試初品区分         -- 生試初品区分
             ,オーダー明細リスト.納入指示日           -- 納入指示日
             ,オーダー明細リスト.完了開始時間         -- 完了開始時間
             ,オーダー明細リスト.完了終了時間         -- 完了終了時間
             ,オーダー明細リスト.納入指示数           -- 納入指示数
             ,オーダー明細リスト.納入キー             -- 納入キー
             ,オーダー明細リスト.受入キー             -- 受入キー
             ,null                                  -- 費用振替先区分
             ,null                                  -- 費用振替先コード
             ,オーダー明細リスト.計画登録者           -- 計画登録者
             ,オーダー明細リスト.理由コード           -- 理由コード
             ,null                                 -- 削除･理由
             ,変数.オーダー発行区分                  -- オーダー発行区分
             ,変数.IC工場処理日                      -- オーダー確定日
             ,null                                  -- 削除日
             ,0                                    -- 納入数量
             ,'2'                                   -- オーダーステータス
             ,null                                  -- 起票日
             ,0                                     -- 更新カウンタ
             ,システム日時                           -- 登録日時
             ,ログインのユーザーID                   -- 登録者
             ,プログラムID                          -- 登録PGID
             ,システム日時                           -- 更新日時
             ,ログインのユーザーID                   -- 更新者
             ,プログラムID                           -- 更新PGID
             )
  ```
- 納入予実績_オーダー明細追加件数を得る

##### 2.3.2.2 独立所要量明細より納入予実績へ追加する

- 以下の条件でデータを独立所要量明細リストに格納する。納入予実績テーブルを追加する。

```sql
     SELECT a.品目番号
           ,a.供給者
           ,a.使用者
           ,a.オーダー番号
           ,a.着手日 AS オリジナル納入指示日
           ,b.品目ステータス
           ,c.工程番号
           ,c.MRP需要方針コード
           ,c.シフト分割数
           ,c.シフトパターン番号
           ,c.荷姿コード
           ,c.荷姿収容数
           ,a.独立需要送り先区分 AS 納入PF／送り先区分
           ,a.独立需要送り先コード AS 納入PF／送り先コード
           ,CASE WHEN a.生試初品区分 IN ('2', '4') THEN '2' ELSE '4' END AS 生試初品区分
           ,a.着手日    AS 納入指示日
           ,a.所要数    AS 納入指示数
           ,a.使用者    AS 納入キー
           ,a.独立需要送り先コード AS 受入キー
           ,a.費用振替先区分
           ,a.費用振替先コード
           ,a.登録者    AS 計画登録者
           ,a.理由コード
       FROM 独立所要量明細 a
 INNER JOIN 品目マスタ b
         ON a.品目番号　　　　　　　=　b.品目番号
        AND a.供給者　　　　　　　　=　b.供給者
        AND a.使用者　　　　　　　　=　b.使用者
        AND b.品目タイプ　　　　　　=　'1'　-- 1:標準
        AND b.品目クラス　　　　　　<>　'1'　-- 1:原材料
 INNER JOIN MRP情報値 c
         ON a.品目番号　　　　　　　=　c.品目番号
        AND a.供給者　　　　　　　　=　c.供給者
        AND a.使用者　　　　　　　　=　c.使用者
        AND c.Wピン管理コード　　　 =　'0'　-- 0：Wビンでない
      WHERE a.所要量区分　　　　　　=　'0'　-- 0：通常
        AND a.オーダーステータス　　=　'2'　-- 2：確定
        AND a.独立需要送り先コード　<>　'CKD'　-- 送り先がCKD以外
        AND NOT EXISTS (
        　SELECT　1
        　  FROM リテラル防止要素 d
        　 WHERE d.システムコード　　　　　='LD'
        　   AND d.リテラル識別コード　　　='LDA00011'
        　   AND d.制御キー１　　　　　　　= a.独立需要送り先コード
        　   AND d.制御キー２　　　　　　　='△'
        　   AND d.制御キー３　　　　　　　='△'
        　   AND d.制御キー４　　　　　　　='△'
             AND d.制御キー５　　　　　　　='△')
        AND (a.供給者　　　<>　a.使用者　　　　OR
         NOT EXISTS (
         　SELECT 1
         　  FROM リテラル防止要素 e
         　 WHERE e.システムコード　　　　　='LD'
         　　 AND e.リテラル識別コード　　　='LDA00012'
        　 　 AND e.制御キー１　　　　　　　= a.使用者
         　　 AND e.制御キー２　　　　　　　='△'
         　　 AND e.制御キー３　　　　　　　='△'
         　　 AND e.制御キー４　　　　　　　='△'
         　　 AND e.制御キー５　　　　　　　='△')
        )
```

- 独立所要量明細リストの該当データがなくなるまで、1件ずつ以下の処理を実施する。

  - 重複データを削除する

  ```sql
  DELETE FROM 納入予実績
        WHERE 品目番号             = 独立所要量明細リスト.品目番号
          AND 供給者               = 独立所要量明細リスト.供給者
          AND 使用者               = 独立所要量明細リスト.使用者
          AND オーダー番号         = 独立所要量明細リスト.オーダー番号
          AND オリジナル納入指示日  = 独立所要量明細リスト.オリジナル納入指示日
  ```

  - 納入予実績へ追加する

  ```sql
  INSERT INTO 納入予実績
      VALUES (独立所要量明細リスト.品目番号                      -- 品目番号
             ,独立所要量明細リスト.供給者                        -- 供給者
             ,独立所要量明細リスト.使用者                        -- 使用者
             ,独立所要量明細リスト.オーダー番号                  -- オーダー番号
             ,独立所要量明細リスト.オリジナル納入指示日          -- オリジナル納入指示日
             ,'2'                                              -- オーダー種別
             ,独立所要量明細リスト.品目ステータス                -- 品目ステータス
             ,独立所要量明細リスト.工程番号                      -- 工程番号
             ,独立所要量明細リスト.MRP需要方針コード             -- MRP需要方針コード
             ,独立所要量明細リスト.シフト分割数                  -- シフト分割数
             ,独立所要量明細リスト.シフトパターン番号            -- シフトパターン番号
             ,独立所要量明細リスト.荷姿コード                    -- 荷姿コード
             ,独立所要量明細リスト.荷姿収容数                    -- 荷姿収容数
             ,独立所要量明細リスト.納入PF／送り先区分            -- 納入PF／送り先区分
             ,独立所要量明細リスト.納入PF／送り先コード          -- 納入PF／送り先コード
             ,独立所要量明細リスト.生試初品区分                  -- 生試初品区分
             ,独立所要量明細リスト.納入指示日                    -- 納入指示日
             ,null                                            -- 完了開始時間
             ,null                                            -- 完了終了時間
             ,独立所要量明細リスト.納入指示数                    -- 納入指示数
             ,独立所要量明細リスト.納入キー                      -- 納入キー
             ,独立所要量明細リスト.受入キー                      -- 受入キー
             ,独立所要量明細リスト.費用振替先区分                -- 費用振替先区分
             ,独立所要量明細リスト.費用振替先コード              -- 費用振替先コード
             ,独立所要量明細リスト.計画登録者                    -- 計画登録者
             ,独立所要量明細リスト.理由コード                    -- 理由コード
             ,null                                             -- 削除･理由
             ,変数.オーダー発行区分                             -- オーダー発行区分
             ,変数.IC工場処理日                                -- オーダー確定日
             ,null                                            -- 削除日
             ,0                                               -- 納入数量
             ,'2'                                             -- オーダーステータス
             ,null                                           -- 起票日
             ,0                                              -- 更新カウンタ
             ,システム日時                                    -- 登録日時
             ,ログインのユーザーID                             -- 登録者
             ,プログラムID                                    -- 登録PGID
             ,システム日時                                    -- 更新日時
             ,ログインのユーザーID                             -- 更新者
             ,プログラムID                                    -- 更新PGID
             )
  ```
- 納入予実績_独立所要量明細追加件数を得る

#### 2.3.3.（処理区分が"2"の場合のみ当処理を実施）オーダー明細より納入予実績の納入指示日を更新する(MRP需要方針コードが"3"のデータのみ)

- 以下の条件でデータを納入指示日リストに格納する。

```sql
     SELECT b.完了日
           ,a.品目番号
           ,a.供給者
           ,a.使用者
           ,a.オーダー番号
           ,a.オリジナル納入指示日
           ,a.更新カウンタ
       FROM 納入予実績 a
 INNER JOIN オーダー明細 b
         ON a.品目番号　　　　　　　= b.品目番号
        AND a.供給者　　　　　　　　= b.供給者
        AND a.使用者　　　　　　　　= b.使用者
        AND a.オーダー番号　　　　　= b.オーダー番号
        AND b.着手日               > 変数.IC工場処理日
 INNER JOIN 品目マスタ c
         ON a.品目番号　　　　　　　= c.品目番号
        AND a.供給者　　　　　　　　= c.供給者
        AND a.使用者　　　　　　　　= c.使用者
        AND c.品目タイプ　　　　　　= '1'　-- 1:標準
 INNER JOIN MRP情報値 d
         ON a.品目番号　　　　　　　= d.品目番号
        AND a.供給者　　　　　　　　= d.供給者
        AND a.使用者　　　　　　　　= d.使用者
        AND d.MRP需要方針コード　　 = a.MRP需要方針コード
 INNER JOIN 確定期間 e
         ON d.確定期間ID　　　　　　= e.確定期間ID
        AND e.確定期間最終日　　　　>= b.着手日
        AND (e.確定実施日 <> b.MRP更新日 OR e.確定実施日 <> b.オーダー確定日)
      WHERE a.MRP需要方針コード    = '3'  -- 3:自動再計画品目
        AND a.供給者　　　　　　　　<> a.使用者
```

- 納入指示日リストの該当データがなくなるまで、1件ずつ納入予実績テーブルを更新する。

```sql
     UPDATE 納入予実績
        SET 納入指示日             = 納入指示日リスト.完了日
           ,更新カウンタ           = 更新カウンタ + 1
           ,更新日時               = システム日時
           ,更新者                 = ログインのユーザーID
           ,更新PGID              = プログラムID
      WHERE 品目番号              = 納入指示日リスト.品目番号
        AND 供給者                = 納入指示日リスト.供給者
        AND 使用者                = 納入指示日リスト.使用者
        AND オーダー番号          = 納入指示日リスト.オーダー番号
        AND オリジナル納入指示日   = 納入指示日リスト.オリジナル納入指示日
```

#### 2.3.4.（処理区分が"1"の場合のみ当処理を実施）在庫取引明細_当日分より納入予実績の実績を更新する

- 以下の条件でデータを在庫取引明細当日分リストに格納する。

```sql
SELECT a.品目番号
      ,a.供給者
      ,a.使用者
      ,a.IC工場処理日
      ,a.IC更新日時
      ,a.内部トランザクションコード
      ,a.ソースコード
      ,a.起票日
      ,a.入庫数
      ,a.出庫数
      ,a.オーダー番号
      ,a.独立需要送り先コード
      ,a.入力処理識別
      ,a.入力変更区分
      ,a.ＴＰ処理番号
      ,a.ＴＰ処理明細番号
  FROM 在庫取引明細当日分 a
 WHERE (a.処理コード　　　=　'00'
         AND a.入力処理識別　　IN　('LD14','LD24','LD46') -- LD14:納入報告,LD24:引取シンクロカード, LD46:独立需要納入報告
         AND NOT EXISTS(
          　SELECT 1
          　  FROM リテラル防止要素 b
          　 WHERE b.システムコード　　　　　= 'LD'
          　   AND b.識別コード　　　　　　　= 'LDA00011'
          　   AND b.制御キー１             = a.独立需要送り先コード
               AND b.制御キー２　　　　　　　= '△'
               AND b.制御キー３　　　　　　　= '△'
               AND b.制御キー４　　　　　　　= '△'
               AND b.制御キー５　　　　　　　= '△')
         AND (a.供給者　<>　a.使用者　　　　OR
              NOT EXISTS (
                　SELECT 1
                 　 FROM リテラル防止要素 c
                 　WHERE c.システムコード　　　　　= 'LD'
                 　  AND c.識別コード　　　　　　　= 'LDA00012'
                 　  AND c.制御キー１             = a.使用者
                     AND c.制御キー２　　　　　　　= '△'
                     AND c.制御キー３　　　　　　　= '△'
                     AND c.制御キー４　　　　　　　= '△'
                     AND c.制御キー５　　　　　　　= '△')))
    OR
       (a.内部トランザクションコード　　　　IN　('21','41') -- 21:納入、41:訂正
        AND a.ソースコード　　　　　　　　　　　= '1'
        AND a.供給者　　　　　　　　　　　　　　<>　a.使用者
       )
```

- 在庫取引明細当日分検索件数を得る
- 在庫取引明細当日分リストの該当データがなくなるまで、1件ずつ以下の処理を実施する。
  - 在庫取引明細当日分の抽出項目値の変換

    - (在庫取引明細当日分リスト.内部トランザクションコード='21'又は　在庫取引明細当日分リスト.内部トランザクションコード='41')
      　且つ　在庫取引明細当日分リスト.ソースコード='1'　且つ　在庫取引明細当日分リスト.供給者<>在庫取引明細当日分リスト.使用者の場合
      　　　・変数.処理識別='LD14'
      　　　・変数.変更区分の設定
      　　　　若し、在庫取引明細当日分リスト.内部トランザクションコード='21'の場合、変数.変更区分='1' 、
      　　　　若し、在庫取引明細当日分リスト.内部トランザクションコード='41'の場合、変数.変更区分='2'
      　　　　※1:納入、2:訂正
      　以外の場合
      　　　・変数.処理識別= 在庫取引明細当日分リスト.入力処理識別
      　　　・変数.変更区分= 在庫取引明細当日分リスト.入力変更区分
    - 変数.入出庫数の設定
      　変数.処理識別='LD46'の場合、
      　　　・変数.入出庫数=在庫取引明細当日分リスト.出庫数
      　変数.処理識別<>'LD46'の場合、
      　　　・変数.入出庫数=在庫取引明細当日分リスト.入庫数
  - 納入予実績の更新

    - 以下の条件でデータを納入予実績リストに格納する。

    ```sql
      SELECT 品目番号
            ,供給者
            ,使用者
            ,オーダー番号
            ,オリジナル納入指示日
            ,納入指示数
            ,納入数量
            ,更新カウンタ
        FROM 納入予実績
       WHERE 品目番号　　　　　　　　=　在庫取引明細当日分リスト.品目番号
         AND 供給者　　　　　　　　　=　在庫取引明細当日分リスト.供給者
         AND 使用者　　　　　　　　　=　在庫取引明細当日分リスト.使用者
         AND オーダー番号　　　　　　=　在庫取引明細当日分リスト.オーダー番号
      -- 若し、変数.変更区分　=　'1'の場合、下記の条件を追加だけ　※1：納入
          AND オーダーステータス　<>　'9'
    ORDER BY 品目番号、供給者、使用者、オーダー番号、
      --若し、変数.変更区分='1'の場合
          オリジナル納入指示日
      --若し、変数.変更区分<>'1'の場合
          オリジナル納入指示日 DESC
    ```

    - データが存在しない場合、エラーログを出力し、異常終了とする。
    - 納入予実績リストの該当データがなくなるまで、1件ずつ以下の処理を実施する。
      - 入出庫数が全て消込み(実績更新)できるかチェック

        - 変更区分='1'の場合　※1：納入
          　変数.入出庫数_計算=変数.入出庫数
          　変数.処理数=納入予実績リスト.納入指示数　–　納入予実績リスト.納入数量
        - 変更区分 = '2'（訂正）の場合
          　変数.入出庫数_計算=変数.入出庫数 * (-1)　※訂正の場合、入出庫数はマイナス数
          　変数.処理数=納入予実績リスト.納入数量
        - 変数.入出庫数_計算＞変数.処理数の場合、エラー出力する
          　変数.不足数=変数.入出庫数_計算 - 変数.処理数
          　出力内容1： '* ld_trn_dlv_pre_record_day Qty Data Error *'
          　出力内容2： 在庫取引明細当日分リスト.品目番号､ 在庫取引明細当日分リスト.供給者､ 在庫取引明細当日分リスト.使用者､変数.処理識別､変数.変更区分､変数.入出庫数、
          　　　　　　　　在庫取引明細当日分リスト.オーダー番号､在庫取引明細当日分リスト.IC工場処理日､ 在庫取引明細当日分リスト.起票日､ 在庫取引明細当日分リスト.IC更新日時､変数.不足数
        - エラーの場合(次処理を行わない)
          変数.オーダーステータス_更新用　=　'9'
          変数.納入数_更新用　　　　　　　=　納入予実績リスト.納入数量
      - 次の在庫取引明細当日分に対する処理を実行して、
        　　変数.納入数_更新用と変数.オーダーステータス_更新用を設定

        - 変数.変更区分 = '1' の場合、
          - 変数.入出庫数_計算 < 変数.処理数の場合
            　・変数.納入数_更新用 = 変数.入出庫数 ＋　納入予実績リスト.納入数量
          - 以外の場合　※変数.入出庫数_計算 = 変数.処理数の場合
            　・変数.納入数_更新用 = 納入予実績リスト.納入指示数
          - 納入予実績リスト.納入指示数 = 変数.納入数_更新用の場合
            　・変数.オーダーステータス_更新用='9'
          - 以外の場合　※納入予実績リスト.納入指示数 <> 変数.納入数_更新用の場合
            　・変数.オーダーステータス_更新用 =' 2'
        - 変数.変更区分='2'の場合
          - 変数.入出庫数_計算＜変数.処理数の場合
            　・変数.納入数_更新用=納入予実績リスト.納入数量　－　変数.入出庫数
          - 以外の場合　※変数.入出庫数_計算=変数.処理数の場合
            　・変数.納入数_更新用=0
          - 変数.オーダーステータス_更新用='2'
      - 納入予実績にデータを更新

        ```sql
        UPDATE 納入予実績
           SET IC工場処理日　　　　 =　在庫取引明細当日分リスト.IC工場処理日
              ,納入数量　　　　　　 =　変数.納入数_更新用
              ,オーダーステータス　 =　変数.オーダーステータス_更新用
              ,起票日　　　　　　　 =　在庫取引明細当日分リスト.起票日
              ,更新カウンタ　　　　 =　更新カウンタ + 1
              ,更新日時            = システム日時
              ,更新者              = ログインのユーザーID
              ,更新PGID            = プログラムID
         WHERE 品目番号　　　　　　 =　納入予実績リスト.品目番号
           AND 供給者　　　　　　　 =　納入予実績リスト.供給者
           AND 使用者　　　　　　　 =　納入予実績リスト.使用者
           AND オーダー番号　　　　 =　納入予実績リスト.オーダー番号
           AND オリジナル納入指示日 =　納入予実績リスト.オリジナル納入指示日
        ```

        - 更新件数は変数.納入予実績_在庫取引明細当日分更新件数を加算する

#### 2.3.5.（処理区分が"1"の場合のみ当処理を実施）削除オーダーのデータを更新する

- 下記の条件により、オーダー明細からデータをオーダー明細削除対象リストに格納する

```sql
   SELECT a.品目番号
         ,a.供給者
         ,a.使用者
         ,a.オーダー番号
         ,a.更新者
         ,a.理由コード
     FROM オーダー明細 a
LEFT JOIN 品目マスタ b
       ON a.品目番号　　　　　　　=　b.品目番号
      AND a.供給者　　　　　　　　=　b.供給者
      AND a.使用者　　　　　　　　=　b.使用者
      AND b.品目タイプ　　　　　　=　'1'　-- 1:標準
LEFT JOIN MRP情報値 c
       ON a.品目番号　　　　　　　=　c.品目番号
      AND a.供給者　　　　　　　　=　c.供給者
      AND a.使用者　　　　　　　　=　c.使用者
      AND c.MRP需要方針コード　　 <>　'1'
      AND c.Wピン管理コード　　   =　'0'
    WHERE a.供給者　　　　　　　　<>　a.使用者
      AND a.削除日　　　　　　　 = 変数.IC工場処理日
```

- オーダー明細_削除対象抽出件数を得る
- オーダー明細削除対象リストの該当データがなくなるまで、1件ずつ納入予実績にデータを更新する

```sql
UPDATE 納入予実績
   SET 削除日               = 変数.IC工場処理日
      ,削除理由             = オーダー明細削除対象リスト.理由コード
      ,オーダーステータス    = '9'
      ,更新カウンタ　　　　　= 更新カウンタ + 1
      ,更新日時             = システム日時
      ,更新者               = ログインのユーザーID
      ,更新PGID             = プログラムID
 WHERE 品目番号             = オーダー明細削除対象リスト.品目番号
   AND 供給者               = オーダー明細削除対象リスト.供給者
   AND 使用者               = オーダー明細削除対象リスト.使用者
   AND オーダー番号          = オーダー明細削除対象リスト.オーダー番号
   AND (オーダーステータス   = '9' OR (オーダーステータス <> '9' AND 納入日 = 変数.IC工場処理日))
```

- 納入予実績_オーダー明細削除対象更新件数を得る
- 下記の条件により、独立所要量明細からデータを独立所要量明細削除対象リストに格納する

```sql
     SELECT a.品目番号
           ,a.供給者
           ,a.使用者
           ,a.オーダー番号
           ,a.更新者
           ,a.理由コード
       FROM 独立所要量明細 a
  LEFT JOIN 品目マスタ b
         ON a.品目番号　　　　　　　=　b.品目番号
        AND a.供給者　　　　　　　　=　b.供給者
        AND a.使用者　　　　　　　　=　b.使用者
        AND b.品目タイプ　　　　　　=　'1'　-- 1:標準
  LEFT JOIN MRP情報値 c
         ON a.品目番号　　　　　　　=　c.品目番号
        AND a.供給者　　　　　　　　=　c.供給者
        AND a.使用者　　　　　　　　=　c.使用者
        AND c.Wピン管理コード　　　 =　'0'　-- 0：Wビンでない
      WHERE a.所要量区分　　　　　　=　'0'　-- 0：通常
        AND a.削除日　　　　　　　  =　変数.IC工場処理日
        AND NOT EXISTS (
        　SELECT　1
        　  FROM リテラル防止要素 d
        　 WHERE d.システムコード　　　　　= 'LD'
        　   AND d.リテラル識別コード　　　= 'LDA00011'
        　   AND d.制御キー１　　　　　　　=  a.独立需要送り先コード
        　   AND d.制御キー２　　　　　　　= '△'
        　   AND d.制御キー３　　　　　　　= '△'
        　   AND d.制御キー４　　　　　　　= '△'
             AND d.制御キー５　　　　　　　= '△')
        AND (a.供給者　　　<>　a.使用者　　　　OR
         NOT EXISTS (
         　SELECT 1
         　  FROM リテラル防止要素 e
         　 WHERE e.システムコード　　　　　= 'LD'
         　　 AND e.リテラル識別コード　　　= 'LDA00012'
        　 　 AND e.制御キー１             = a.使用者
         　　 AND e.制御キー２　　　　　　　= '△'
         　　 AND e.制御キー３　　　　　　　= '△'
         　　 AND e.制御キー４　　　　　　　= '△'
         　　 AND e.制御キー５　　　　　　　= '△')
        )
```

- 独立所要量明細_削除対象抽出件数を得る
- 独立所要量明細削除対象リストの該当データがなくなるまで、1件ずつ納入予実績にデータを更新する

```sql
UPDATE 納入予実績
   SET 削除日                 = 変数.IC工場処理日
      ,削除理由               = 独立所要量明細削除対象リスト.理由コード
      ,オーダーステータス      = '9'
      ,更新カウンタ　　　　　  = 更新カウンタ + 1
      ,更新日時               = システム日時
      ,更新者                = ログインのユーザーID
      ,更新PGID              = プログラムID
 WHERE 品目番号              = 独立所要量明細削除対象リスト.品目番号
   AND 供給者                = 独立所要量明細削除対象リスト.供給者
   AND 使用者                = 独立所要量明細削除対象リスト.使用者
   AND オーダー番号           =  独立所要量明細削除対象リスト.オーダー番号
   AND (オーダーステータス   = '9' OR (オーダーステータス <> '9' AND 納入日 = 変数.IC工場処理日))
```

- 納入予実績_独立所要量明細削除対象更新件数を得る

### 2.4. 終了処理

- 納入予実績_オーダー明細追加件数をログに出力する
- 納入予実績_独立所要量明細追加件数をログに出力する
- 在庫取引明細当日分検索件数をログに出力する
- 納入予実績_在庫取引明細当日分更新件数をログに出力する
- オーダー明細_削除対象抽出件数をログに出力する
- 納入予実績_オーダー明細削除対象更新件数をログに出力する
- 独立所要量明細_削除対象抽出件数をログに出力する
- 納入予実績_独立所要量明細削除対象更新件数をログに出力する
