# 0. 表紙

| モジュール名 | プログラムID | プログラム名             |
| ------------ | ------------ | ------------------------ |
| IC           | LDPJ0003     | 設計変更所要量更新リスト |

| RFC       | Version | 更新日     | 更新者 | 更新内容 | 確認日     | 確認者 | 承認日     | 承認者 |
| --------- | :-----: | ---------- | :----: | -------- | ---------- | :----: | ---------- | :----: |
| XXXX-XXXX |  1.0.0  | 2025/11/12 | 陳培煌 | 初版作成 | 2025/XX/XX |        | 2025/XX/XX |        |

## 1. 処理概要

### 1.1. 機能概要

設計変更所要量更新ログから、リスト未出力レコードを抽出し、PDFでリスト出力する。
抽出レコードを出力済に更新する。
ログ：共通の部品を用いる(lombok)

### 1.2. 処理概要フロー

### 1.3. プログラム入出力パラメータ

#### 1.3.1. 引数

| No. | パラメータ論理名 | パラメータ物理名 | 属性   | 識別 | 備考 |
| --- | ---------------- | ---------------- | ------ | ---- | ---- |
| 1   | 出力パス         | out1             | String | 必須 |      |

#### 1.3.2. 戻り値

| No. | パラメータ論理名 | パラメータ物理名 | 属性 | 備考             |
| --- | ---------------- | ---------------- | ---- | ---------------- |
| 1   | リターンコード   | r_status         | int  | 正常：0 異常：-1 |

### 1.4. その他制御・要件

| 排他制御 |      |      |
| -------- | ---- | ---- |
| 楽観     | 悲観 | 無し |
| -        | -    | ●   |

| 項目               | 制約・制御・要件など                                                 | 記載内容説明                                                                                                       |
| ------------------ | -------------------------------------------------------------------- | ------------------------------------------------------------------------------------------------------------------ |
| パフォーマンス要件 | IC分析本体で、リストデータは作成されるが、リスト作成は後処理で行う。 | リストはPDFファイルとする。 更新系の本体処理では、パフォーマンスを維持するため、PDFファイルは、 後処理で実施する。 |

### 1.5. 入出力一覧

| No | 入出力対象 | 名称                     | 物理名称          | C  | R  | U  | D | 備考        |
| -- | ---------- | ------------------------ | ----------------- | -- | -- | -- | - | ----------- |
| 1  | テーブル   | 設計変更所要量更新ログ   | ld_trn_reqchg_log | -  | ○ | ○ | - |             |
| 2  | テーブル   | 品目共通                 | la_itemcomn       | -  | ○ | -  | - |             |
| 3  | テーブル   | IC工場処理日             | ld_mst_slip_date  | -  | ○ | -  | - |             |
| 4  | 帳票       | 設計変更所要量更新リスト | LDAR022           | ○ | -  | -  | - | PDFファイル |

## 2. 詳細処理

### 2.1. 引数の受け取りとチェック

#### 2.1.1. 引数の取得

- 引数out1(出力パス)を取得する

#### 2.1.2. 引数のチェック

- 必須チェック: out1が空でないこと
- チェックエラーの場合、エラーメッセージを出力し、異常終了する

### 2.2. 初期処理

- 工場処理日を検索する

  ```sql
        SELECT ic_slip_date    -- IC工場処理日
          FROM ld_mst_slip_date -- IC工場処理日
         WHERE operation_type = 'STD'
  ```

  - 取得した工場処理日が存在しない場合、エラーロゴを出力する、異常終了する。
  - 存在する場合、変数.工場処理日にセットする

### 2.3. 主処理

#### 2.3.1. 設計変更所要量更新ログから、リスト未出力レコードを抽出し、未出力リストに格納する

```sql
     SELECT A.org_section_mrp   AS orgSectionMrp        -- 担当課
           ,A.org_person_mrp    AS orgPersonMrp         -- 担当者
           ,B.global_itemno     AS globalItemno         -- 編集品目番号
           ,A.comp_supplier     AS compSupplier         -- 子供給者
           ,A.comp_usercd       AS compUsercd           -- 子使用者
           ,A.order_no          AS orderNo              -- オーダー番号
           ,A.start_date        AS startDate            -- 着手日
           ,A.parent_itemno     AS parentItemno         -- 親品目番号
           ,A.parent_supplier   AS parentSupplier       -- 親供給者
           ,A.parent_usercd     AS parentUsercd         -- 親使用者
           ,A.structure_seq     AS structureSeq         -- 構成連番
           ,A.required_qty      AS requiredQty          -- 所要数
           ,A.out_qty           AS outQty               -- 出庫数
           ,A.in_effective_ymd  AS inEffectiveYmd       -- IN発効日
           ,A.out_effective_ymd AS outEffectiveYmd      -- OUT発効日
           ,CASE A.add_del_sign
                WHEN '1' THEN '追加'
                WHEN '3' THEN '削除'
                ELSE ' '
            END AS addDelStr                            -- 追削区分
           ,CASE A.message_code
                WHEN '200' THEN '構成変更'
                WHEN '210' THEN '所要量出庫管理'
                ELSE ' '
            END AS messageStr                           -- メッセージコード
           ,COALESCE(B.item_name, ' ') AS itemName      -- 品目名称
       FROM ld_trn_reqchg_log A                         -- 設計変更所要量更新ログ
  LEFT JOIN la_itemcomn B                               -- 品目共通
         ON A.comp_itemno = B.itemno
      WHERE A.list_flg    = '0'
   ORDER BY A.org_section_mrp, A.org_person_mrp, A.comp_itemno, A.comp_supplier, A.comp_usercd,
            A.order_no, A.start_date, A.parent_itemno, A.parent_supplier, A.parent_usercd, A.structure_seq
```

#### 2.3.2. 帳票出力

- 帳票出力
  - 担当課毎にリストファイルを分割する　ファイル名「設計変更所要量更新リストyyyymmdd_xx」（リスト名＋工場処理日＋担当課）
  - 改ページ条件：担当者、担当課が変更された時また明細行が最大表示行数を超えた時

#### 2.3.3. 設計変更所要量更新ログテーブル更新

- 出力したレコードのリスト出力フラグを'1'に更新する

```sql
UPDATE ld_trn_reqchg_log                     -- 設計変更所要量更新ログ
   SET list_flg        = '1'                 -- リスト出力フラグ
      ,update_counter  = update_counter + 1  -- 更新カウンタ
      ,update_datetime = STATEMENT_TIMESTAMP() -- 更新日時
      ,update_author   = 'ldpj0003'          -- 更新者
      ,update_pgmid    = 'ldpj0003'          -- 更新プログラムID
 WHERE list_flg        = '0'                 -- リスト出力フラグ(未出力)
```

### 2.4. 終了処理

- 処理結果ログ出力
  - 処理件数(抽出レコード数)をログ出力
  - 更新件数(リスト出力フラグ更新数)をログ出力
  - 担当課毎の出力件数をログ出力

## 3. ファイル出力（帳票、CSV、テキスト、Excelなど）

### 3.1. 帳票出力

#### 3.1.1. 帳票レイアウト

![LDPJ0003_設計変更所要量更新リスト_帳票レイアウト_image_001](image/LDPJ0003/LDPJ0003_001.png)

#### 3.1.2. 帳票項目定義

| No | エリア         | 項目名 | 項目物理名 | 種別 | 表示/非表示 | 最大 | 最小 | 小数桁 | 表示位置 | 表示時編集内容                           | ソース名   | 項目名 | ソート順                                                                                                            | 備考 |
| -- | -------------- | ------ | ---------- | ---- | ----------- | ---- | ---- | ------ | -------- | ---------------------------------------- | ---------- | ------ | ------------------------------------------------------------------------------------------------------------------- | ---- |
| 1  | リストID       | ヘッダ | 文字列     | 固定 | 7           |      | 7    |        | 左揃え   | 固定：LDAR022                            |            |        |                                                                                                                     |      |
| 2  | 発行日         | ヘッダ | 日付       | 可変 | 10          |      | 8    |        | 左揃え   | システム日付                             | YYYY-MM-DD |        |                                                                                                                     |      |
| 3  | ページ         | ヘッダ | 数値       | 可変 | 4           |      | 4    |        | 右揃え   | 1から採番                                |            |        |                                                                                                                     |      |
| 4  | 担当課         | ヘッダ | 文字列     | 可変 | 2           |      | 2    |        | 左揃え   | 設計変更所要量更新ログ．担当課           |            | 1      | 担当課毎にリストファイルを分割するファイル名「設計変更所要量更新リストyyyymmdd_xx」（リスト名＋工場処理日＋担当課） |      |
| 5  | 担当者         | ヘッダ | 文字列     | 可変 | 3           |      | 3    |        | 左揃え   | 設計変更所要量更新ログ．担当者           |            | 2      | 担当者毎に改ページする                                                                                              |      |
| 6  | 品目番号       | 明細   | 文字列     | 可変 | 18          |      | 14   |        | 左揃え   | 設計変更所要量更新ログ．子品目番号       |            | 3      |                                                                                                                     |      |
| 7  | 供給者         | 明細   | 文字列     | 可変 | 4           |      | 4    |        | 中央     | 設計変更所要量更新ログ．子供給者         |            | 4      |                                                                                                                     |      |
| 8  | 使用者         | 明細   | 文字列     | 可変 | 4           |      | 4    |        | 中央     | 設計変更所要量更新ログ．子使用者         |            | 5      |                                                                                                                     |      |
| 9  | オーダー番号   | 明細   | 文字列     | 可変 | 5           |      | 5    |        | 中央     | 設計変更所要量更新ログ．通算オーダー番号 |            | 6      |                                                                                                                     |      |
| 10 | 着手日         | 明細   | 日付       | 可変 | 10          |      | 8    |        | 中央     | 設計変更所要量更新ログ．着手日           | YYYY-MM-DD | 7      |                                                                                                                     |      |
| 11 | 品目名称       | 明細   | 文字列     | 可変 | 4           |      | 4    |        | 左揃え   | 品目共通                                 |            |        |                                                                                                                     |      |
| 12 | 親品目番号     | 明細   | 文字列     | 可変 | 18          |      | 14   |        | 左揃え   | 設計変更所要量更新ログ．親品目番号       |            | 8      |                                                                                                                     |      |
| 13 | 親供給者       | 明細   | 文字列     | 可変 | 4           |      | 4    |        | 中央     | 設計変更所要量更新ログ．親供給者         |            | 9      |                                                                                                                     |      |
| 14 | 親使用者       | 明細   | 文字列     | 可変 | 4           |      | 4    |        | 中央     | 設計変更所要量更新ログ．親使用者         |            | 10     |                                                                                                                     |      |
| 15 | シーケンス番号 | 明細   | 数値       | 可変 | 3           |      | 3    |        | 中央     | 設計変更所要量更新ログ．構成連番         |            | 11     |                                                                                                                     |      |
| 16 | 所要数         | 明細   | 数値       | 可変 | 8           | 0    | 6    |        | 右揃え   | 設計変更所要量更新ログ．所要量数         |            |        |                                                                                                                     |      |
| 17 | 出庫数         | 明細   | 数値       | 可変 | 8           | 0    | 6    |        | 右揃え   | 設計変更所要量更新ログ．出庫数           |            |        |                                                                                                                     |      |
| 18 | IN発効日       | 明細   | 日付       | 可変 | 10          |      | 8    |        | 中央     | 設計変更所要量更新ログ．IN発効日         | YYYY-MM-DD |        |                                                                                                                     |      |
| 19 | OUT発効日      | 明細   | 日付       | 可変 | 10          |      | 8    |        | 中央     | 設計変更所要量更新ログ．OUT発効日        | YYYY-MM-DD |        |                                                                                                                     |      |
| 20 | 処理           | 明細   | 漢字       | 可変 | 2           |      | 4    |        | 左揃え   |                                          |            |        |                                                                                                                     |      |
| 21 | 理由           | 明細   | 漢字       | 可変 | 9           |      | 18   |        | 左揃え   |                                          |            |        |                                                                                                                     |      |

### 3.2. ファイル入出力（CSV、テキスト、Excel など）

#### 3.2.1. ファイルレイアウト
